# VisionCore Enterprise Edition

**ä¼ä¸šçº§å·¥ä¸šè§†è§‰æ£€æµ‹ç³»ç»Ÿ** - é«˜æ€§èƒ½ã€æ¨¡å—åŒ–ã€å¤šçº¿ç¨‹ã€è·¨å¹³å°æ¶æ„

[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)
[![Python](https://img.shields.io/badge/python-3.8+-blue.svg)](https://www.python.org/)
[![Platform](https://img.shields.io/badge/platform-Windows%20%7C%20Linux%20%7C%20ARM-lightgrey.svg)]()

---

## ğŸ“– ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [æ ¸å¿ƒç‰¹æ€§](#æ ¸å¿ƒç‰¹æ€§)
- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [ç›®å½•ç»“æ„](#ç›®å½•ç»“æ„)
- [æ ¸å¿ƒæ¨¡å—è¯¦è§£](#æ ¸å¿ƒæ¨¡å—è¯¦è§£)
- [æ”¯æŒçš„å‘½ä»¤](#æ”¯æŒçš„å‘½ä»¤)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [éƒ¨ç½²æŒ‡å—](#éƒ¨ç½²æŒ‡å—)
- [å¼€å‘æŒ‡å—](#å¼€å‘æŒ‡å—)
- [æ€§èƒ½æŒ‡æ ‡](#æ€§èƒ½æŒ‡æ ‡)
- [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)
- [æ›´æ–°æ—¥å¿—](#æ›´æ–°æ—¥å¿—)
- [è®¸å¯è¯](#è®¸å¯è¯)

---

## æ¦‚è¿°

VisionCore Enterprise Edition æ˜¯ä¸€å¥—**ä¼ä¸šçº§å·¥ä¸šè§†è§‰æ£€æµ‹ç³»ç»Ÿ**ï¼Œé‡‡ç”¨æ¸…æ™°çš„åˆ†å±‚æ¶æ„ã€æ¨¡å—åŒ–è®¾è®¡ã€å¤šçº¿ç¨‹å¹¶å‘å¤„ç†ï¼Œä¸“ä¸ºå·¥ä¸šè‡ªåŠ¨åŒ–åœºæ™¯æ‰“é€ ã€‚

### è®¾è®¡ç†å¿µ

- **åˆ†å±‚æ¸…æ™°**: ä¸¥æ ¼çš„é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰ï¼Œé€šè®¯å±‚ã€ä¸šåŠ¡é€»è¾‘å±‚ã€æœåŠ¡å±‚å®Œå…¨è§£è€¦
- **è·¨å¹³å°æ”¯æŒ**: åŒæ—¶æ”¯æŒ Windows PCã€Linux x86_64 å’Œ ARM (RK3588) å¹³å°
- **å¤šåç«¯å¼•æ“**: AIæ£€æµ‹å’Œç›¸æœºå‡æ”¯æŒ Python/C++ åŒåç«¯ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜å®ç°
- **é«˜å¯ç”¨æ€§**: å¤šçº¿ç¨‹å¥åº·ç›‘æ§ã€è‡ªåŠ¨é‡è¿ã€æ•…éšœè‡ªåŠ¨æ¢å¤
- **å®æ—¶æ§åˆ¶**: æ”¯æŒè¿ç»­æ£€æµ‹å¾ªç¯ã€GPIOä¼ é€å¸¦æ§åˆ¶ã€EtherCATä¼ºæœæ§åˆ¶

### åº”ç”¨åœºæ™¯

- ğŸ­ **å·¥ä¸šè‡ªåŠ¨åŒ–**: äº§å“ç¼ºé™·æ£€æµ‹ã€åˆ†æ‹£ã€å®šä½
- ğŸ¤– **æœºå™¨äººå¼•å¯¼**: è§†è§‰å®šä½ã€åæ ‡æ ‡å®šã€æŠ“å–å¼•å¯¼
- ğŸ“¦ **ç‰©æµåˆ†æ‹£**: åŒ…è£¹è¯†åˆ«ã€å°ºå¯¸æµ‹é‡ã€ä½ç½®æ£€æµ‹
- ğŸ” **è´¨é‡æ£€éªŒ**: äº§å“å¤–è§‚æ£€æµ‹ã€å°ºå¯¸æµ‹é‡ã€ç¼ºé™·è¯†åˆ«

---

## æ ¸å¿ƒç‰¹æ€§

### ğŸ¥ å¤šç›¸æœºæ”¯æŒ

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **SICK 3Dç›¸æœº** | å®Œæ•´ SICK Visionary SDK é›†æˆï¼Œæ”¯æŒæ·±åº¦å›¾ã€å¼ºåº¦å›¾ã€ç›¸æœºå‚æ•°è·å– |
| **åŒåç«¯æ¶æ„** | Python SDK åç«¯ + C++ é«˜æ€§èƒ½åç«¯ï¼ˆ`vc_camera_cpp`ï¼‰ |
| **è‡ªåŠ¨é‡è¿** | æ–­çº¿è‡ªåŠ¨é‡è¿æœºåˆ¶ï¼Œä¿è¯ç³»ç»Ÿç¨³å®šæ€§ |
| **é¢„çƒ­æœºåˆ¶** | é¦–æ¬¡å–å›¾é¢„çƒ­ï¼Œå‡å°‘å®é™…æ£€æµ‹å»¶è¿Ÿ |
| **å¸§å·éªŒè¯** | æ£€æµ‹æ—§å¸§å¤ç”¨é—®é¢˜ï¼ˆARMå¹³å°ç‰¹æœ‰ï¼‰ï¼Œè‡ªåŠ¨é‡è¯•è·å–æ–°å¸§ |

### ğŸ§  AI æ£€æµ‹å¼•æ“

| åç«¯ | å¹³å° | è¯´æ˜ |
|------|------|------|
| **PC Ultralytics** | Windows/Linux x86 | åŸºäº Ultralytics YOLOï¼Œæ”¯æŒåˆ†å‰²æ¨¡å‹ |
| **RKNN Python** | Linux ARM (RK3588) | RKNN-Toolkit2 Python æ¨ç† |
| **RKNN C++** | Linux ARM (RK3588) | C++ å®ç°ï¼ˆ`vc_detection_cpp`ï¼‰ï¼Œæ›´é«˜æ€§èƒ½ |

**ç‰¹æ€§**:
- å·¥å‚æ¨¡å¼è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜åç«¯ï¼ˆ`backend: auto`ï¼‰
- ç½®ä¿¡åº¦ã€NMSé˜ˆå€¼å¯é…ç½®
- é¢„çƒ­æ¨ç†é¿å…é¦–æ¬¡æ£€æµ‹å»¶è¿Ÿ
- æ”¯æŒå®ä¾‹åˆ†å‰²ï¼ˆMaskï¼‰

### ğŸ“¡ åŒé€šä¿¡åè®®

| åè®® | ç‰¹æ€§ |
|------|------|
| **TCP æœåŠ¡å™¨** | å¤šçº¿ç¨‹å¹¶å‘ã€å¤šå®¢æˆ·ç«¯æ”¯æŒã€å¿ƒè·³æ£€æµ‹ã€é«˜æ€§èƒ½ `catch` å‘½ä»¤ |
| **MQTT å®¢æˆ·ç«¯** | ç‹¬ç«‹çº¿ç¨‹ã€è¿œç¨‹å‘½ä»¤æ§åˆ¶ã€QoS 2 å¯é ä¼ è¾“ |

### ğŸ”„ å®æ—¶æŠ“å–æ§åˆ¶ç³»ç»Ÿ

VisionCore æ”¯æŒ**è¿ç»­æ£€æµ‹å¾ªç¯æ¨¡å¼**ï¼Œé€‚ç”¨äºä¼ é€å¸¦è‡ªåŠ¨åˆ†æ‹£åœºæ™¯ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿ç»­æ£€æµ‹å¾ªç¯ (start å‘½ä»¤å¯åŠ¨)                               â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ å–å›¾ â”‚ â†’ â”‚ æ£€æµ‹ â”‚ â†’ â”‚ GPIO  â”‚ â†’ â”‚ åæ ‡ â”‚ â†’ â”‚ TCPå‘é€  â”‚ â”‚
â”‚  â”‚      â”‚   â”‚      â”‚   â”‚ æ§åˆ¶  â”‚   â”‚ è®¡ç®— â”‚   â”‚ (æœºå™¨äºº) â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                â†“                                            â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚        â”‚ ç­‰å¾… complete   â”‚ â† æœºå™¨äººæŠ“å–å®Œæˆåå‘é€            â”‚
â”‚        â”‚ æ¶ˆæ¯åç»§ç»­å‘é€   â”‚                                  â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹æ€§**:
- GPIO ä¼ é€å¸¦æ§åˆ¶ï¼ˆROI å†…æœ‰ç›®æ ‡æ—¶åœæ­¢ä¼ é€å¸¦ï¼‰
- ç‰©ä½“ç¨³å®šç­‰å¾…æœºåˆ¶ï¼ˆä¼ é€å¸¦åœæ­¢åç­‰å¾…ç‰©ä½“ç¨³å®šï¼‰
- æœºå™¨äººæŠ“å–çŠ¶æ€ç®¡ç†ï¼ˆç­‰å¾… `complete` æ¶ˆæ¯åç»§ç»­å‘é€ï¼‰
- å¤š ROI ä¼˜å…ˆçº§é€‰æ‹©

### âš¡ EtherCAT ä¼ºæœæ§åˆ¶ (SOEM æ¨¡å—)

åŸºäº **PySOEM** çš„ EtherCAT ä¸»ç«™å®ç°ï¼Œæ”¯æŒ **ä¿¡æ· DS5C1S ä¼ºæœé©±åŠ¨å™¨**ï¼š

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **åè®®** | EtherCAT CoE (CANopen over EtherCAT) |
| **æ ‡å‡†** | CiA 402 è®¾å¤‡è§„èŒƒ |
| **æ¨¡å¼** | é€Ÿåº¦æ¨¡å¼ (PV)ã€ä½ç½®æ¨¡å¼ (PP) |
| **å‚æ•°** | 17ä½ç¼–ç å™¨ã€æœ€å¤§ 3000 RPM |

```python
from soem import EtherCATMaster, XinJeDS5C1S, ServoMode

master = EtherCATMaster("\\Device\\NPF_{GUID}")
master.open()
master.scan_slaves()

servo = XinJeDS5C1S(master, slave_index=0, pdo_mode='velocity')
servo.set_mode(ServoMode.PROFILE_VELOCITY)
master.set_operational()
master.start_cycle(0.001)  # 1ms å¾ªç¯

servo.set_target_velocity(1000)  # 1000 RPM
```

### ğŸ“ åæ ‡æ ‡å®šç³»ç»Ÿ

**ä¸¤æ­¥æ ‡å®šå·¥ä½œæµ**:

1. **`get_calibrat_image`**: æ£€æµ‹12ä¸ªé»‘å—ï¼Œè¿”å›ä¸–ç•Œåæ ‡
2. **`coordinate_calibration`**: æ¥æ”¶æœºå™¨äººåæ ‡ï¼Œæ‰§è¡Œæ ‡å®šè®¡ç®—

**ç‰¹æ€§**:
- 12ç‚¹æ ‡å®šï¼ˆ3Ã—4 ç½‘æ ¼å¸ƒå±€ï¼‰
- å¤šç§äºŒå€¼åŒ–ç­–ç•¥ï¼ˆOtsuã€è‡ªé€‚åº”é˜ˆå€¼ã€CLAHEï¼‰
- XY ä»¿å°„ + Z çº¿æ€§å˜æ¢æ¨¡å‹
- ç²¾åº¦éªŒè¯ï¼ˆRMSEã€è´¨é‡è¯„çº§ï¼‰

---

## ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    subgraph "å¤–éƒ¨æ¥å£å±‚"
        TCP[TCP Server<br/>å¤šçº¿ç¨‹å¹¶å‘<br/>Port 8888]
        MQTT[MQTT Client<br/>å¼‚æ­¥æ¶ˆæ¯]
        SFTP[SFTP Client<br/>æ–‡ä»¶ä¸Šä¼ ]
    end
    
    subgraph "å‘½ä»¤è·¯ç”±å±‚"
        Router[Command Router<br/>ç»Ÿä¸€å‘½ä»¤åˆ†å‘]
    end
    
    subgraph "ä¸šåŠ¡é€»è¾‘å±‚ (handlers/)"
        Config[Config Handler<br/>é…ç½®ç®¡ç†]
        Camera_Handler[Camera Handler<br/>ç›¸æœºå¤„ç†]
        Detection_Handler[Detection Handler<br/>æ£€æµ‹å¤„ç†]
        Calib_Handler[Calibration Handler<br/>æ ‡å®šå¤„ç†]
        System_Handler[System Handler<br/>è¿ç»­æ£€æµ‹å¾ªç¯]
    end
    
    subgraph "æ ¸å¿ƒæœåŠ¡å±‚ (services/)"
        Camera[Camera Service<br/>Python/C++ åŒåç«¯]
        Detector[Detector Service<br/>PC/RKNN/C++ å¤šåç«¯]
        Calibrator[Calibration Service<br/>åæ ‡æ ‡å®š]
        GPIO[GPIO Service<br/>ä¼ é€å¸¦æ§åˆ¶]
    end
    
    subgraph "åŸºç¡€è®¾æ–½å±‚"
        SICK_SDK[SICK Visionary SDK<br/>Python + C++]
        RKNN[RKNN Toolkit<br/>NPU åŠ é€Ÿ]
        vclib[vclib/<br/>é¢„ç¼–è¯‘ C++ æ‰©å±•]
    end
    
    subgraph "å¤–éƒ¨ç¡¬ä»¶"
        SICK_Camera[SICK 3D ç›¸æœº]
        Robot[æœºå™¨äººæ§åˆ¶å™¨]
        Conveyor[ä¼ é€å¸¦]
        Servo[ä¿¡æ·ä¼ºæœé©±åŠ¨å™¨<br/>EtherCAT]
    end
    
    TCP --> Router
    MQTT --> Router
    Router --> Config
    Router --> Camera_Handler
    Router --> Detection_Handler
    Router --> Calib_Handler
    Router --> System_Handler
    
    Camera_Handler --> Camera
    Detection_Handler --> Detector
    Detection_Handler --> GPIO
    Calib_Handler --> Calibrator
    System_Handler --> Camera
    System_Handler --> Detector
    System_Handler --> GPIO
    
    Camera --> SICK_SDK
    Camera --> vclib
    Detector --> RKNN
    Detector --> vclib
    
    SICK_SDK --> SICK_Camera
    GPIO --> Conveyor
    TCP --> Robot
    
    style TCP fill:#e1f5ff
    style MQTT fill:#e1f5ff
    style Router fill:#f3e5f5
    style vclib fill:#fff3e0
```

### æ£€æµ‹åç«¯é€‰æ‹©æµç¨‹

```mermaid
graph TD
    Start[é…ç½® backend] --> Auto{backend = auto?}
    Auto -->|æ˜¯| Platform{æ£€æµ‹å¹³å°}
    Auto -->|å¦| Manual{æ‰‹åŠ¨é€‰æ‹©}
    
    Platform -->|Windows| PC[PC Ultralytics]
    Platform -->|Linux ARM| UseCpp{use_cpp = true?}
    
    UseCpp -->|æ˜¯| CPP_RKNN[C++ RKNN åç«¯<br/>vc_detection_cpp]
    UseCpp -->|å¦| PY_RKNN[Python RKNN åç«¯<br/>rknn_backend.py]
    
    Manual -->|pc| PC
    Manual -->|rknn| UseCpp
    
    PC --> Result[æ£€æµ‹å™¨å®ä¾‹]
    CPP_RKNN --> Result
    PY_RKNN --> Result
```

---

## ç›®å½•ç»“æ„

```
VisualCoreEnterpriseEdition/
â”‚
â”œâ”€â”€ app/                                    # åº”ç”¨å…¥å£å±‚
â”‚   â”œâ”€â”€ main.py                            # ä¸»ç¨‹åºå…¥å£
â”‚   â””â”€â”€ bootstrap.py                       # å¯åŠ¨å¼•å¯¼å’Œä¾èµ–æ³¨å…¥
â”‚
â”œâ”€â”€ domain/                                 # é¢†åŸŸæ¨¡å‹å±‚ï¼ˆDDDï¼‰
â”‚   â”œâ”€â”€ enums/                             
â”‚   â”‚   â””â”€â”€ commands.py                    # å‘½ä»¤æšä¸¾ï¼ˆVisionCoreCommandsï¼‰
â”‚   â””â”€â”€ models/                            
â”‚       â””â”€â”€ mqtt.py                        # MQTTå“åº”æ¨¡å‹
â”‚
â”œâ”€â”€ handlers/                               # ä¸šåŠ¡é€»è¾‘å±‚ - å‘½ä»¤å¤„ç†å™¨
â”‚   â”œâ”€â”€ context.py                         # å‘½ä»¤ä¸Šä¸‹æ–‡ï¼ˆä¾èµ–æ³¨å…¥å®¹å™¨ï¼‰
â”‚   â”œâ”€â”€ config.py                          # é…ç½®ç®¡ç†å‘½ä»¤å¤„ç†å™¨
â”‚   â”œâ”€â”€ camera.py                          # ç›¸æœºå‘½ä»¤å¤„ç†å™¨
â”‚   â”œâ”€â”€ detection.py                       # æ£€æµ‹å‘½ä»¤å¤„ç†å™¨ (model_test, catch)
â”‚   â”œâ”€â”€ calibration.py                     # æ ‡å®šå‘½ä»¤å¤„ç†å™¨
â”‚   â””â”€â”€ system.py                          # ç³»ç»Ÿå‘½ä»¤ (start/stop è¿ç»­æ£€æµ‹å¾ªç¯)
â”‚
â”œâ”€â”€ services/                               # æ ¸å¿ƒæœåŠ¡å±‚
â”‚   â”œâ”€â”€ camera/                            # ç›¸æœºæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ sick_camera.py                 # SICK Python åç«¯
â”‚   â”‚   â”œâ”€â”€ cpp_camera.py                  # C++ åç«¯å°è£…
â”‚   â”‚   â””â”€â”€ hik_tof.py                     # HIK ToF ç›¸æœºï¼ˆé¢„ç•™ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ detection/                         # æ£€æµ‹æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ base.py                        # æ£€æµ‹å™¨æŠ½è±¡åŸºç±»
â”‚   â”‚   â”œâ”€â”€ factory.py                     # æ£€æµ‹å™¨å·¥å‚ï¼ˆè‡ªåŠ¨é€‰æ‹©åç«¯ï¼‰
â”‚   â”‚   â”œâ”€â”€ pc_ultralytics.py             # PC ç«¯ Ultralytics æ£€æµ‹å™¨
â”‚   â”‚   â”œâ”€â”€ rknn_backend.py               # RKNN Python åç«¯
â”‚   â”‚   â”œâ”€â”€ cpp_backend.py                # RKNN C++ åç«¯å°è£…
â”‚   â”‚   â”œâ”€â”€ coordinate_processor.py        # åæ ‡å¤„ç†å™¨ï¼ˆåƒç´ â†’ä¸–ç•Œåæ ‡ï¼‰
â”‚   â”‚   â”œâ”€â”€ target_selector.py             # ç›®æ ‡é€‰æ‹©å™¨ï¼ˆå¤š ROI ä¼˜å…ˆçº§ï¼‰
â”‚   â”‚   â”œâ”€â”€ roi_processor.py               # ROI å¤„ç†å™¨
â”‚   â”‚   â””â”€â”€ visualizer.py                  # å¯è§†åŒ–å·¥å…·
â”‚   â”‚
â”‚   â”œâ”€â”€ calibration/                       # æ ‡å®šæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ black_block_detector.py        # é»‘å—æ£€æµ‹å™¨
â”‚   â”‚   â””â”€â”€ calibrator.py                  # æ ‡å®šè®¡ç®—å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ comm/                              # é€šä¿¡æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ tcp_server.py                  # TCP å¤šçº¿ç¨‹æœåŠ¡å™¨
â”‚   â”‚   â”œâ”€â”€ mqtt_client.py                 # MQTT å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ comm_manager.py                # é€šä¿¡ç®¡ç†å™¨
â”‚   â”‚   â””â”€â”€ command_router.py              # å‘½ä»¤è·¯ç”±å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ servo/                             # GPIO æ§åˆ¶æœåŠ¡
â”‚   â”‚   â””â”€â”€ gpio.py                        # GPIO è¾“å‡ºæ§åˆ¶ï¼ˆä¼ é€å¸¦ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ sftp/                              # SFTP æœåŠ¡
â”‚   â”‚   â””â”€â”€ sftp_client.py                 # SFTP å®¢æˆ·ç«¯
â”‚   â”‚
â”‚   â”œâ”€â”€ shared/                            # å…±äº«å·¥å…·
â”‚   â”‚   â”œâ”€â”€ image_utils.py                 # å›¾åƒå¤„ç†å·¥å…·
â”‚   â”‚   â”œâ”€â”€ sftp_helper.py                 # SFTP è¾…åŠ©å·¥å…·
â”‚   â”‚   â””â”€â”€ calibration_utils.py           # æ ‡å®šåæ ‡è½¬æ¢å·¥å…·
â”‚   â”‚
â”‚   â”œâ”€â”€ system/                            # ç³»ç»ŸæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ initializer.py                 # ç³»ç»Ÿåˆå§‹åŒ–å™¨
â”‚   â”‚   â”œâ”€â”€ monitor.py                     # ç³»ç»Ÿç›‘æ§å™¨ï¼ˆå¤šçº¿ç¨‹ï¼‰
â”‚   â”‚   â””â”€â”€ log_manager.py                 # æ—¥å¿—ç®¡ç†å™¨
â”‚   â”‚
â”‚   â””â”€â”€ cpp/                               # C++ æ‰©å±•æºç 
â”‚       â”œâ”€â”€ CMakeLists.txt                 # ä¸» CMake é…ç½®
â”‚       â”œâ”€â”€ camera/                        # ç›¸æœº C++ æ¨¡å—
â”‚       â”‚   â”œâ”€â”€ VisionaryCameraLib.cpp    # SICK ç›¸æœºå°è£…
â”‚       â”‚   â””â”€â”€ bindings.cpp              # pybind11 ç»‘å®š
â”‚       â””â”€â”€ detection/                     # æ£€æµ‹ C++ æ¨¡å—
â”‚           â”œâ”€â”€ RKNNDetector.cpp          # RKNN æ£€æµ‹å™¨
â”‚           â””â”€â”€ bindings.cpp              # pybind11 ç»‘å®š
â”‚
â”œâ”€â”€ vclib/                                  # é¢„ç¼–è¯‘ C++ æ‰©å±•åº“
â”‚   â”œâ”€â”€ x86/                               # Windows x86_64
â”‚   â”‚   â”œâ”€â”€ vc_camera_cpp.pyd             # ç›¸æœºæ¨¡å—
â”‚   â”‚   â””â”€â”€ vc_detection_cpp.pyd          # æ£€æµ‹æ¨¡å—
â”‚   â””â”€â”€ aarch/                             # Linux ARM64 (RK3588)
â”‚       â”œâ”€â”€ vc_camera_cpp.so              # ç›¸æœºæ¨¡å—
â”‚       â””â”€â”€ vc_detection_cpp.so           # æ£€æµ‹æ¨¡å—
â”‚
â”œâ”€â”€ soem/                                   # EtherCAT ä¸»ç«™æ¨¡å—
â”‚   â”œâ”€â”€ ethercat_master.py                 # EtherCAT ä¸»ç«™å®ç°
â”‚   â”œâ”€â”€ servo_drive.py                     # CiA 402 ä¼ºæœé©±åŠ¨å™¨åŸºç±»
â”‚   â”œâ”€â”€ xinje_servo.py                     # ä¿¡æ· DS5C1S ä¼ºæœå®ç°
â”‚   â””â”€â”€ examples/                          # ä½¿ç”¨ç¤ºä¾‹
â”‚
â”œâ”€â”€ infrastructure/                         # åŸºç¡€è®¾æ–½å±‚
â”‚   â”œâ”€â”€ sick/                              # SICK SDK Python å°è£…
â”‚   â”œâ”€â”€ sick_visionary_cpp_shared/         # SICK Visionary C++ SDK
â”‚   â””â”€â”€ yolov8-seg-thread-stream/          # YOLOv8 å¤šçº¿ç¨‹æ£€æµ‹å‚è€ƒ
â”‚
â”œâ”€â”€ configs/                                # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ config.yaml                        # ä¸»é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ transformation_matrix.json         # åæ ‡å˜æ¢çŸ©é˜µ
â”‚   â””â”€â”€ warmup_image.jpg                   # é¢„çƒ­å›¾åƒ
â”‚
â”œâ”€â”€ models/                                 # AI æ¨¡å‹æ–‡ä»¶
â”‚   â”œâ”€â”€ *.pt                               # PyTorch æ¨¡å‹ï¼ˆPC ç«¯ï¼‰
â”‚   â””â”€â”€ *.rknn                             # RKNN æ¨¡å‹ï¼ˆARM ç«¯ï¼‰
â”‚
â”œâ”€â”€ docker/                                 # Docker éƒ¨ç½²é…ç½®
â”‚   â”œâ”€â”€ Dockerfile                         # æ ‡å‡† Docker é•œåƒ
â”‚   â”œâ”€â”€ Dockerfile.gpu                     # GPU åŠ é€Ÿé•œåƒ
â”‚   â”œâ”€â”€ Dockerfile.rk3588                  # RK3588 é•œåƒ
â”‚   â””â”€â”€ docker-compose.*.yml               # ç¼–æ’é…ç½®
â”‚
â”œâ”€â”€ scripts/                                # è¿ç»´è„šæœ¬
â”œâ”€â”€ tests/                                  # æµ‹è¯•è„šæœ¬
â”œâ”€â”€ logs/                                   # æ—¥å¿—æ–‡ä»¶
â”œâ”€â”€ debug/                                  # è°ƒè¯•è¾“å‡º
â”‚
â”œâ”€â”€ requirements.txt                        # Python ä¾èµ–
â”œâ”€â”€ LICENSE                                 # MIT è®¸å¯è¯
â””â”€â”€ README.md                               # æœ¬æ–‡æ¡£
```

---

## æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. ç›¸æœºæ¨¡å— (services/camera/)

æ”¯æŒä¸¤ç§åç«¯ï¼š

```python
# Python åç«¯ï¼ˆå…¼å®¹æ€§å¥½ï¼‰
from services.camera.sick_camera import SickCamera
camera = SickCamera(ip="192.168.2.99", port=2122)

# C++ åç«¯ï¼ˆé«˜æ€§èƒ½ï¼Œæ¨èï¼‰
from services.camera.cpp_camera import CppCamera
camera = CppCamera(ip="192.168.2.99", port=2122)

# è·å–æ•°æ®
frame = camera.get_frame(depth=True, intensity=True, camera_params=True)
# è¿”å›: {
#   'intensity_image': np.ndarray,    # å¼ºåº¦å›¾åƒ 256x256
#   'depthmap': np.ndarray,            # æ·±åº¦å›¾ 256x256
#   'cameraParams': {...},             # ç›¸æœºå‚æ•°
#   'frame_num': int,                  # å¸§å·
#   'timestamp_ms': int                # æ—¶é—´æˆ³
# }
```

### 2. æ£€æµ‹æ¨¡å— (services/detection/)

```python
from services.detection.factory import create_detector

# è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜åç«¯
detector = create_detector(config)
detector.load()

# æ‰§è¡Œæ£€æµ‹
results = detector.detect(image)
# è¿”å›: List[DetectionResult]
# æ¯ä¸ªç»“æœåŒ…å«: xmin, ymin, xmax, ymax, class_id, score, seg_mask
```

**åç«¯é€‰æ‹©é€»è¾‘**:
- Windows â†’ PC Ultralytics
- Linux ARM + `use_cpp: true` â†’ C++ RKNN
- Linux ARM + `use_cpp: false` â†’ Python RKNN

### 3. GPIO æ§åˆ¶ (services/servo/)

ç”¨äºæ§åˆ¶ä¼ é€å¸¦å¯åœï¼š

```python
from services.servo.gpio import GPIO

gpio = GPIO()
gpio.open(chip="/dev/gpiochip3", pin=20, consumer="conveyor")

gpio.high()  # ä¼ é€å¸¦è¿è¡Œ
gpio.low()   # ä¼ é€å¸¦åœæ­¢
```

### 4. è¿ç»­æ£€æµ‹å¾ªç¯ (handlers/system.py)

é€šè¿‡ `start` å‘½ä»¤å¯åŠ¨è¿ç»­æ£€æµ‹ï¼š

```python
# å¾ªç¯æµç¨‹:
while running:
    # 1. å–å›¾
    frame = camera.get_frame()
    
    # 2. æ£€æµ‹
    detections = detector.detect(frame['intensity_image'])
    
    # 3. GPIO æ§åˆ¶ (æ¯ä¸ª ROI ç‹¬ç«‹)
    for roi in rois:
        count = count_in_roi(detections, roi)
        if count > 0:
            gpio[roi].low()   # æœ‰ç›®æ ‡ï¼Œåœæ­¢ä¼ é€å¸¦
        else:
            gpio[roi].high()  # æ— ç›®æ ‡ï¼Œç»§ç»­è¿è¡Œ
    
    # 4. åæ ‡è®¡ç®—å’Œå‘é€ (ç­‰å¾…æœºå™¨äºº complete åæ‰å‘é€ä¸‹ä¸€ä¸ª)
    if best_target and not is_robot_picking:
        coords = calculate_robot_coords(best_target)
        tcp_send(coords)
        is_robot_picking = True  # ç­‰å¾… complete
```

### 5. EtherCAT ä¼ºæœæ§åˆ¶ (soem/)

```python
from soem import EtherCATMaster, XinJeDS5C1S, ServoMode

# åˆå§‹åŒ–ä¸»ç«™
master = EtherCATMaster("\\Device\\NPF_{GUID}")
master.open()
slave_count = master.scan_slaves()
master.config_map()

# åˆ›å»ºä¼ºæœå¯¹è±¡
servo = XinJeDS5C1S(master, slave_index=0, pdo_mode='velocity')
servo.set_mode(ServoMode.PROFILE_VELOCITY)

# è¿›å…¥è¿è¡ŒçŠ¶æ€
master.set_operational()
master.start_cycle(0.001)  # 1ms å‘¨æœŸ

# æ§åˆ¶é€Ÿåº¦
servo.enable()
servo.set_target_velocity(1000)  # 1000 RPM

# åœæ­¢
servo.set_target_velocity(0)
master.close()
```

---

## æ”¯æŒçš„å‘½ä»¤

### MQTT/TCP å‘½ä»¤

| å‘½ä»¤ | åŠŸèƒ½ | è¯´æ˜ |
|------|------|------|
| `get_config` | è·å–ç³»ç»Ÿé…ç½® | è¿”å›å®Œæ•´é…ç½®å’Œæ¨¡å‹åˆ—è¡¨ |
| `save_config` | ä¿å­˜ç³»ç»Ÿé…ç½® | è‡ªåŠ¨å¤‡ä»½ï¼Œæ”¯æŒçƒ­æ›´æ–° |
| `get_image` | è·å–ç›¸æœºå›¾åƒ | è¿”å›å›¾åƒ + SFTP ä¸Šä¼ ä¿¡æ¯ |
| `model_test` | æµ‹è¯• AI æ¨¡å‹ | æ£€æµ‹æ•°é‡ + æ¨ç†æ—¶é—´ + å¯è§†åŒ– |
| `get_calibrat_image` | è·å–æ ‡å®šå›¾åƒ | 12ä¸ªé»‘å—ä¸–ç•Œåæ ‡ |
| `coordinate_calibration` | æ‰§è¡Œåæ ‡æ ‡å®š | è®¡ç®—å˜æ¢çŸ©é˜µ + RMSE |
| `catch` | å•æ¬¡æ£€æµ‹æŠ“å– | è¿”å›æœºå™¨äººåæ ‡ |
| `start` | å¯åŠ¨è¿ç»­æ£€æµ‹ | GPIO æ§åˆ¶ + å¾ªç¯æ£€æµ‹ |
| `stop` | åœæ­¢è¿ç»­æ£€æµ‹ | é‡Šæ”¾èµ„æº |

### TCP å“åº”æ ¼å¼

**catch å‘½ä»¤**:
```
p1_count,p2_count,x,y,z
```
- `p1_count`: P1 ROI å†…ç›®æ ‡æ•°é‡
- `p2_count`: P2 ROI å†…ç›®æ ‡æ•°é‡
- `x,y,z`: æœºå™¨äººåæ ‡ï¼ˆmmï¼‰

**start è¿ç»­æ¨¡å¼**:
```
x,y,z
```
- ç›´æ¥è¿”å›åæ ‡ï¼Œç”±æœºå™¨äººå‘é€ `complete` è¡¨ç¤ºæŠ“å–å®Œæˆ

**é”™è¯¯ç **:
- `0,0,0,0,0`: æœªæ£€æµ‹åˆ°ç›®æ ‡
- `E1,...`: ç›¸æœº/æ£€æµ‹å™¨æœªå°±ç»ª

---

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

| é¡¹ç›® | è¦æ±‚ |
|------|------|
| Python | 3.8+ |
| Windows | 10+ |
| Linux | Ubuntu 18.04+ / Debian 11+ |
| ARM | RK3588 (RKNN Runtime) |
| ç›¸æœº | SICK Visionary ç³»åˆ— |

### å®‰è£…ä¾èµ–

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd VisualCoreEnterpriseEdition

# å®‰è£… Python ä¾èµ–
pip install -r requirements.txt

# ä¸»è¦ä¾èµ–
pip install opencv-python ultralytics paho-mqtt numpy pyyaml paramiko

# ARM å¹³å°é¢å¤–ä¾èµ–
pip install rknn-toolkit2  # ä» Rockchip å®˜æ–¹è·å–
```

### è¿è¡Œç³»ç»Ÿ

```bash
# å¼€å‘æ¨¡å¼
python -m app.main

# è¾“å‡ºç¤ºä¾‹:
# VisionCorePro starting...
# âœ“ C++åº“è·¯å¾„å‡†å¤‡å®Œæˆ | vclib/x86
# âœ“ TCPæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ | 192.168.2.90:8888
# âœ“ ç›¸æœºè¿æ¥æˆåŠŸ | 192.168.2.99:2122
# âœ“ ç›¸æœºé¢„çƒ­å®Œæˆ | è€—æ—¶=145.2ms
# âœ“ æ£€æµ‹å™¨åŠ è½½æˆåŠŸ | åç«¯: pc
# âœ“ æ£€æµ‹å™¨é¢„çƒ­å®Œæˆ | è€—æ—¶=234.5ms | æ£€æµ‹æ•°=2
# âœ“ ç³»ç»Ÿå¯åŠ¨å®Œæˆ | å…³é”®ç»„ä»¶å…¨éƒ¨å°±ç»ª
```

---

## é…ç½®è¯´æ˜

### ä¸»é…ç½®æ–‡ä»¶ (configs/config.yaml)

```yaml
# æ—¥å¿—é…ç½®
logging:
  enable: true
  level: INFO
  console:
    enable: true
  file:
    enable: true
    path: logs
    backup_count: 30

# ç›‘æ§é…ç½®
board_mode:
  retry_delay: 5           # é‡è¯•å»¶è¿Ÿï¼ˆç§’ï¼‰
  monitoring:
    check_interval: 30     # å¥åº·æ£€æŸ¥é—´éš”
    failure_threshold: 1   # å¤±è´¥é˜ˆå€¼

# ç›¸æœºé…ç½®
camera:
  enable: true
  backend: cpp            # cpp | sick (è‡ªåŠ¨é€‰æ‹© C++ åç«¯)
  connection:
    ip: 192.168.2.99
    port: 2122
  mode:
    useSingleStep: true

# æ£€æµ‹æ¨¡å‹é…ç½®
model:
  backend: auto           # auto | pc | rknn
  use_cpp: true           # RKNN æ—¶ä½¿ç”¨ C++ åç«¯
  
  # å¹³å°ç‰¹å®šé…ç½®
  windows:
    path: models/seasoning.pt
  aarch:
    path: models/seasoning.rknn
  
  conf_threshold: 0.75
  nms_threshold: 0.65

# TCP æœåŠ¡å™¨
DetectionServer:
  enable: true
  host: 192.168.2.90
  port: 8888
  max_connections: 15
  heartbeat_interval: 30

# ROI é…ç½®ï¼ˆå¤š ROI ä¼˜å…ˆçº§ï¼‰
roi:
  enable: true
  minArea: 3000           # æœ€å°é¢ç§¯é˜ˆå€¼
  depthThreshold: 665     # æ·±åº¦é˜ˆå€¼
  stabilityWaitTime: 0.15 # ç‰©ä½“ç¨³å®šç­‰å¾…æ—¶é—´
  
  regions:
    - name: main_work_area
      width: 150
      height: 100
      offsetx: 0
      offsety: 30
      priority: 1         # ä¼˜å…ˆçº§æœ€é«˜
      gpio:
        enable: true
        chip: /dev/gpiochip3
        pin: 20
    
    - name: backup_area
      width: 150
      height: 100
      offsetx: 90
      offsety: 140
      priority: 2

# SFTPï¼ˆå¯é€‰ï¼‰
sftp:
  enable: false
  host: 192.168.2.126
  port: 22
  username: qt
  password: '123456'
```

---

## éƒ¨ç½²æŒ‡å—

### Linux ç³»ç»ŸæœåŠ¡

```bash
# å®‰è£…åˆ°ç³»ç»Ÿç›®å½•
sudo cp -r . /opt/VisionCoreEE
cd /opt/VisionCoreEE
sudo pip3 install -r requirements.txt

# é…ç½® systemd æœåŠ¡
sudo cp scripts/visioncore.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable visioncore
sudo systemctl start visioncore

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status visioncore
sudo journalctl -u visioncore -f
```

### Docker éƒ¨ç½²

```bash
# æ„å»ºé•œåƒ
cd docker
docker build -t visioncore:latest -f Dockerfile ..

# RK3588 å¹³å°
docker build -t visioncore:rk3588 -f Dockerfile.rk3588 ..

# è¿è¡Œ
docker-compose up -d
```

### Windows æœåŠ¡

ä½¿ç”¨ NSSM (Non-Sucking Service Manager):

```cmd
nssm install VisionCoreEE "C:\Python38\python.exe" "C:\VisionCoreEE\app\main.py"
nssm start VisionCoreEE
```

---

## æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| TCP å“åº”å»¶è¿Ÿ | < 200ms | å•æ¬¡ catch å‘½ä»¤ |
| è¿ç»­æ£€æµ‹å‘¨æœŸ | 10ms | start æ¨¡å¼å¾ªç¯é—´éš” |
| æ£€æµ‹é€Ÿåº¦ (PC) | 30-50 FPS | NVIDIA RTX ç³»åˆ— |
| æ£€æµ‹é€Ÿåº¦ (RKNN C++) | 15-25 FPS | RK3588 NPU |
| ç›¸æœºå–å›¾ | 100-150ms | SICK 3D å•å¸§ |
| åæ ‡è®¡ç®— | < 5ms | åƒç´ â†’æœºå™¨äººåæ ‡ |
| å†…å­˜å ç”¨ | < 500MB | æ­£å¸¸è¿è¡Œæ—¶ |
| æ ‡å®šç²¾åº¦ | XY: 2-3mm, Z: 3-5mm | 12ç‚¹æ ‡å®š |

---

## æ•…éšœæ’é™¤

### Q1: ç›¸æœºè¿æ¥å¤±è´¥

```bash
# æµ‹è¯•ç½‘ç»œè¿é€šæ€§
ping 192.168.2.99
telnet 192.168.2.99 2122

# æ£€æŸ¥é˜²ç«å¢™
sudo ufw status
```

### Q2: C++ æ¨¡å—åŠ è½½å¤±è´¥

```
# æ£€æŸ¥ vclib ç›®å½•
ls vclib/x86/  # Windows
ls vclib/aarch/  # Linux ARM

# ç¡®è®¤ Python ç‰ˆæœ¬åŒ¹é…
python --version  # éœ€è¦ä¸ç¼–è¯‘æ—¶ä¸€è‡´
```

### Q3: RKNN æ¨ç†å¤±è´¥

```bash
# æ£€æŸ¥ RKNN Runtime
cat /proc/rknn/version

# ç¡®è®¤ NPU å¯ç”¨
ls /dev/dri/
```

### Q4: GPIO æ§åˆ¶æ— æ•ˆ

```bash
# æ£€æŸ¥ GPIO æƒé™
ls -la /dev/gpiochip*
sudo usermod -aG gpio $USER

# æµ‹è¯• GPIO
python -c "from services.servo.gpio import GPIO; g = GPIO(); g.open('/dev/gpiochip3', 20); g.high()"
```

---

## æ›´æ–°æ—¥å¿—

### v1.3.0 (2025-12)

#### ğŸš€ æ–°å¢åŠŸèƒ½

- âœ… **è¿ç»­æ£€æµ‹å¾ªç¯**: `start`/`stop` å‘½ä»¤ï¼Œæ”¯æŒä¼ é€å¸¦è‡ªåŠ¨åˆ†æ‹£
- âœ… **GPIO ä¼ é€å¸¦æ§åˆ¶**: å¤š ROI ç‹¬ç«‹ GPIO æ§åˆ¶
- âœ… **æœºå™¨äººæŠ“å–çŠ¶æ€ç®¡ç†**: ç­‰å¾… `complete` æ¶ˆæ¯æœºåˆ¶
- âœ… **ç‰©ä½“ç¨³å®šç­‰å¾…**: ä¼ é€å¸¦åœæ­¢åè‡ªåŠ¨ç­‰å¾…ç‰©ä½“ç¨³å®š
- âœ… **æ·±åº¦å¢é‡è®¡æ•°**: åŸºäºæ·±åº¦é˜ˆå€¼çš„ç‰©ä½“è®¡æ•°å¢é‡

#### ğŸ”§ æ”¹è¿›

- ğŸ“ˆ C++ åç«¯æ€§èƒ½ä¼˜åŒ–
- ğŸ›¡ï¸ å¸§å·éªŒè¯é˜²æ­¢æ—§å¸§å¤ç”¨ï¼ˆARM å¹³å°ï¼‰
- ğŸ“‹ è¯¦ç»†çš„å¾ªç¯æ—¥å¿—è¾“å‡º

### v1.2.0 (2025-11)

- âœ… åˆ†å±‚æ¶æ„ä¼˜åŒ–
- âœ… handlers ä» services/comm ç‹¬ç«‹
- âœ… ä¸šåŠ¡é€»è¾‘å±‚ä¸é€šè®¯å±‚å®Œå…¨è§£è€¦

### v1.1.0 (2025-11)

- âœ… å¤šçº¿ç¨‹æ¶æ„é‡æ„
- âœ… TCP å¤šå®¢æˆ·ç«¯æ”¯æŒ
- âœ… ç‹¬ç«‹ç›‘æ§çº¿ç¨‹

---

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

---

## è‡´è°¢

- [Ultralytics YOLO](https://github.com/ultralytics/ultralytics) - æ£€æµ‹å¼•æ“
- [SICK AG](https://www.sick.com/) - SICK Visionary SDK
- [PySOEM](https://github.com/bnjmnp/pysoem) - EtherCAT ä¸»ç«™åº“
- [Paho MQTT](https://www.eclipse.org/paho/) - MQTT å®¢æˆ·ç«¯
- [OpenCV](https://opencv.org/) - å›¾åƒå¤„ç†

---

<div align="center">

**Built with â¤ï¸ for Industrial Automation**

**æµç¨‹å›¾é¢„è§ˆæ’ä»¶æ¨èï¼š**
- VSCode: å®‰è£… "Markdown Preview Mermaid Support"
- GitHub: åŸç”Ÿæ”¯æŒ
- åœ¨çº¿é¢„è§ˆ: https://mermaid.live/

[â¬† è¿”å›é¡¶éƒ¨](#visioncore-enterprise-edition)

</div>
