# å†…å­˜ç®¡ç†æŒ‡å—

## ğŸ“‹ ç›®å½•
- [buff/cache æ˜¯ä»€ä¹ˆ](#buffcache-æ˜¯ä»€ä¹ˆ)
- [å¦‚ä½•åˆ¤æ–­æ˜¯å¦æœ‰å†…å­˜æ³„æ¼](#å¦‚ä½•åˆ¤æ–­æ˜¯å¦æœ‰å†…å­˜æ³„æ¼)
- [å†…å­˜ä¼˜åŒ–æªæ–½](#å†…å­˜ä¼˜åŒ–æªæ–½)
- [ç›‘æ§å’Œè¯Šæ–­å·¥å…·](#ç›‘æ§å’Œè¯Šæ–­å·¥å…·)
- [æ¸…ç†ç¼“å­˜](#æ¸…ç†ç¼“å­˜)

---

## ğŸ” buff/cache æ˜¯ä»€ä¹ˆ

### **Linux å†…å­˜ç®¡ç†æœºåˆ¶**

```
$ free -h
              total        used        free      shared  buff/cache   available
Mem:           15Gi       3.2Gi       8.5Gi       128Mi       3.8Gi        11Gi
```

- **buffers**: å—è®¾å¤‡ï¼ˆç£ç›˜ï¼‰çš„ç¼“å†²åŒº
- **cached**: æ–‡ä»¶é¡µç¼“å­˜ï¼ˆæé«˜æ–‡ä»¶è¯»å†™æ€§èƒ½ï¼‰
- **buff/cache**: buffers + cached çš„æ€»å’Œ

### **é‡è¦æ¦‚å¿µ**

1. **buff/cache æ˜¯å¯å›æ”¶å†…å­˜**
   - å½“åº”ç”¨ç¨‹åºéœ€è¦æ›´å¤šå†…å­˜æ—¶ï¼Œå†…æ ¸ä¼šè‡ªåŠ¨é‡Šæ”¾ç¼“å­˜
   - `available` å­—æ®µ = `free` + **å¤§éƒ¨åˆ†** `buff/cache`
   
2. **buff/cache é«˜æ˜¯æ­£å¸¸çš„**
   - Linux çš„è®¾è®¡å“²å­¦ï¼š**ç©ºé—²å†…å­˜æ˜¯æµªè´¹çš„å†…å­˜**
   - ç³»ç»Ÿä¼šç”¨ç©ºé—²å†…å­˜ç¼“å­˜æ–‡ä»¶ï¼Œæé«˜ I/O æ€§èƒ½
   
3. **çœŸæ­£è¦å…³æ³¨çš„æŒ‡æ ‡**
   - **available** (å¯ç”¨å†…å­˜) è€Œä¸æ˜¯ **free** (ç©ºé—²å†…å­˜)
   - å¦‚æœ `available` å¾ˆä½ï¼Œæ‰è¯´æ˜å†…å­˜ä¸è¶³

---

## ğŸ” å¦‚ä½•åˆ¤æ–­æ˜¯å¦æœ‰å†…å­˜æ³„æ¼

### **1. ä½¿ç”¨ç›‘æ§è„šæœ¬**

```bash
# å®æ—¶ç›‘æ§ VisionCore è¿›ç¨‹å†…å­˜
python scripts/monitor_memory.py 5

# è¾“å‡ºç¤ºä¾‹ï¼š
æ—¶é—´         | RSS       | VMS       | å…±äº«      | CPU%  | ç³»ç»Ÿå†…å­˜% | Buff/Cache
08:30:15    | 256.32MB  | 1.2GB     | 45.6MB    | 12.3% |    65.2%  | 3.8GB
08:30:20    | 258.41MB  | 1.2GB     | 45.8MB    | 11.8% |    65.3%  | 3.8GB â†‘2.09MB
```

**åˆ¤æ–­æ ‡å‡†**ï¼š
- âœ… **æ­£å¸¸**ï¼šRSS ç¨³å®šæˆ–å°å¹…æ³¢åŠ¨ï¼ˆÂ±50MBï¼‰
- âš ï¸ **è­¦å‘Š**ï¼šRSS æŒç»­ç¼“æ…¢å¢é•¿ï¼ˆæ¯å°æ—¶ >100MBï¼‰
- âŒ **æ³„æ¼**ï¼šRSS å¿«é€Ÿå¢é•¿ä¸”ä¸å›è½

### **2. æ£€æŸ¥ç³»ç»Ÿå†…å­˜**

```bash
# è¿è¡Œè¯Šæ–­è„šæœ¬
bash scripts/check_memory.sh

# å…³é”®æŒ‡æ ‡ï¼š
# - MemAvailable: å¯ç”¨å†…å­˜ï¼ˆåŒ…æ‹¬å¯å›æ”¶çš„ç¼“å­˜ï¼‰
# - å…±äº«å†…å­˜æ®µ: æ£€æŸ¥æ˜¯å¦æœ‰å­¤ç«‹çš„å…±äº«å†…å­˜
# - /dev/shm: æ£€æŸ¥ä¸´æ—¶æ–‡ä»¶æ˜¯å¦æ¸…ç†
```

### **3. å¯¹æ¯”ç¨‹åºè¿è¡Œå‰å**

```bash
# è¿è¡Œå‰
free -h > memory_before.txt

# è¿è¡Œ VisionCore
python -m app.main

# è¿è¡Œä¸­ï¼ˆå¦ä¸€ä¸ªç»ˆç«¯ï¼‰
watch -n 1 'free -h'

# åœæ­¢å
free -h > memory_after.txt

# å¯¹æ¯”
diff memory_before.txt memory_after.txt
```

**æœŸæœ›ç»“æœ**ï¼š
- åœæ­¢å `available` åº”è¯¥æ¥è¿‘è¿è¡Œå‰çš„æ°´å¹³
- `buff/cache` å¯èƒ½ä»ç„¶è¾ƒé«˜ï¼ˆ**è¿™æ˜¯æ­£å¸¸çš„ï¼**ï¼‰

---

## âš¡ å†…å­˜ä¼˜åŒ–æªæ–½

### **1. ä»£ç å±‚é¢ä¼˜åŒ–ï¼ˆå·²å®æ–½ï¼‰**

#### **âœ… æ˜¾å¼èµ„æºé‡Šæ”¾**
```python
# æ‰€æœ‰ç»„ä»¶éƒ½å®ç°äº† release() å’Œ __del__() æ–¹æ³•
detector.release()  # é‡Šæ”¾æ¨¡å‹èµ„æº
camera.release()    # é‡Šæ”¾ç›¸æœºè¿æ¥å’Œç¼“å†²åŒº
```

#### **âœ… æ˜¾å¼åˆ é™¤å¤§å¯¹è±¡**
```python
# åœ¨å¾ªç¯ä¸­åŠæ—¶åˆ é™¤ numpy æ•°ç»„
del img, depth_data, result, dets
```

#### **âœ… å®šæœŸåƒåœ¾å›æ”¶**
```python
# æ¯100æ¬¡å¾ªç¯æ‰§è¡Œä¸€æ¬¡ GC
if loop_count % 100 == 0:
    gc.collect()
```

#### **âœ… ç¨‹åºé€€å‡ºæ—¶æ·±åº¦æ¸…ç†**
```python
# å¤šæ¬¡åƒåœ¾å›æ”¶ï¼Œæ¸…ç†å¾ªç¯å¼•ç”¨
gc.collect()
gc.collect()
gc.collect()
```

### **2. ç³»ç»Ÿå±‚é¢ä¼˜åŒ–**

#### **è°ƒæ•´ Python å†…å­˜åˆ†é…å™¨**

```bash
# ä½¿ç”¨ jemalloc æ›¿ä»£é»˜è®¤åˆ†é…å™¨ï¼ˆå¯é€‰ï¼‰
sudo apt install libjemalloc2
export LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libjemalloc.so.2
python -m app.main
```

#### **é™åˆ¶è¿›ç¨‹å†…å­˜ä¸Šé™**

```bash
# ä½¿ç”¨ systemd é™åˆ¶å†…å­˜ï¼ˆæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰
# åˆ›å»º /etc/systemd/system/visioncore.service

[Unit]
Description=VisionCore Enterprise Edition

[Service]
Type=simple
User=your_user
WorkingDirectory=/path/to/VisualCoreEnterpriseEdition
ExecStart=/usr/bin/python3 -m app.main
MemoryLimit=2G           # é™åˆ¶æœ€å¤§å†…å­˜ä¸º 2GB
MemoryMax=2G
MemoryHigh=1.8G          # è¾¾åˆ° 1.8GB æ—¶å¼€å§‹å‹åŠ›å›æ”¶

[Install]
WantedBy=multi-user.target
```

---

## ğŸ“Š ç›‘æ§å’Œè¯Šæ–­å·¥å…·

### **1. å®æ—¶å†…å­˜ç›‘æ§**

```bash
# æ–¹å¼1ï¼šä½¿ç”¨é¡¹ç›®æä¾›çš„è„šæœ¬
python scripts/monitor_memory.py 5

# æ–¹å¼2ï¼šä½¿ç”¨ htop
htop -p $(pgrep -f "python.*main")

# æ–¹å¼3ï¼šä½¿ç”¨ top
top -p $(pgrep -f "python.*main")

# æ–¹å¼4ï¼šwatch + ps
watch -n 1 'ps aux | grep python.*main | grep -v grep'
```

### **2. å†…å­˜å¿«ç…§åˆ†æ**

```python
# åœ¨ä»£ç ä¸­æ·»åŠ å†…å­˜å¿«ç…§ï¼ˆè°ƒè¯•æ—¶ä½¿ç”¨ï¼‰
import tracemalloc

# å¼€å§‹è¿½è¸ª
tracemalloc.start()

# ... è¿è¡Œä»£ç  ...

# è·å–å¿«ç…§
snapshot = tracemalloc.take_snapshot()
top_stats = snapshot.statistics('lineno')

# æ˜¾ç¤ºå†…å­˜å ç”¨æœ€å¤šçš„å‰10è¡Œ
print("[ Top 10 ]")
for stat in top_stats[:10]:
    print(stat)
```

### **3. å†…å­˜è¯Šæ–­è„šæœ¬**

```bash
# å…¨é¢æ£€æŸ¥å†…å­˜çŠ¶æ€
bash scripts/check_memory.sh

# è¾“å‡ºåŒ…æ‹¬ï¼š
# - æ€»ä½“å†…å­˜ä½¿ç”¨
# - VisionCore è¿›ç¨‹è¯¦æƒ…
# - å…±äº«å†…å­˜æ®µ
# - /dev/shm ä½¿ç”¨æƒ…å†µ
# - buff/cache è¯¦ç»†ä¿¡æ¯
```

---

## ğŸ§¹ æ¸…ç†ç¼“å­˜

### **âš ï¸ é‡è¦æé†’**

- **buff/cache é«˜ä¸æ˜¯é—®é¢˜ï¼** é™¤éï¼š
  1. `available` å†…å­˜å¾ˆä½ï¼ˆ<10%ï¼‰
  2. ç³»ç»Ÿå‡ºç° OOM (Out of Memory) é”™è¯¯
  3. éœ€è¦è¿›è¡Œå†…å­˜æµ‹è¯•

### **æ¸…ç†æ–¹æ³•**

#### **æ–¹å¼1ï¼šä½¿ç”¨æ¸…ç†è„šæœ¬ï¼ˆæ¨èï¼‰**

```bash
# éœ€è¦ root æƒé™
sudo bash scripts/clear_cache.sh

# è„šæœ¬ä¼šæ‰§è¡Œï¼š
# 1. åŒæ­¥ç£ç›˜ç¼“å†²åŒº
# 2. æ¸…ç†é¡µç¼“å­˜
# 3. æ¸…ç†ç›®å½•é¡¹å’Œinode
# 4. æ¸…ç†å­¤ç«‹çš„å…±äº«å†…å­˜
```

#### **æ–¹å¼2ï¼šæ‰‹åŠ¨æ¸…ç†**

```bash
# 1. åŒæ­¥ç£ç›˜
sync

# 2. æ¸…ç†é¡µç¼“å­˜
sudo sh -c 'echo 1 > /proc/sys/vm/drop_caches'

# 3. æ¸…ç†ç›®å½•é¡¹å’Œinode
sudo sh -c 'echo 2 > /proc/sys/vm/drop_caches'

# 4. æ¸…ç†æ‰€æœ‰ç¼“å­˜
sudo sh -c 'echo 3 > /proc/sys/vm/drop_caches'
```

#### **æ–¹å¼3ï¼šæ¸…ç†å…±äº«å†…å­˜**

```bash
# æŸ¥çœ‹å…±äº«å†…å­˜
ipcs -m

# åˆ é™¤æŒ‡å®šçš„å…±äº«å†…å­˜æ®µ
ipcrm -m <shared_memory_id>

# åˆ é™¤æ‰€æœ‰å­¤ç«‹çš„å…±äº«å†…å­˜ï¼ˆéœ€è°¨æ…ï¼‰
ipcs -m | awk 'NR>3 {print $2}' | xargs -I {} ipcrm -m {}
```

### **æ¸…ç†åçš„é¢„æœŸ**

```bash
$ free -h

# æ¸…ç†å‰ï¼š
Mem:  15Gi  3.2Gi  8.5Gi  128Mi  3.8Gi  11Gi
       â†‘æ€»  â†‘å·²ç”¨  â†‘ç©ºé—² â†‘å…±äº«  â†‘ç¼“å­˜  â†‘å¯ç”¨

# æ¸…ç†åï¼š
Mem:  15Gi  3.2Gi  11.3Gi  128Mi  500Mi  13.5Gi
              â†‘      â†‘              â†“      â†‘
         ä½¿ç”¨ä¸å˜  ç©ºé—²å¢åŠ       ç¼“å­˜å‡å°‘  å¯ç”¨å¢åŠ 
```

**æ³¨æ„**ï¼š
- ç¼“å­˜ä¼šå¾ˆå¿«é‡æ–°å¢é•¿ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼ï¼‰
- æ¸…ç†åç³»ç»Ÿå¯èƒ½æš‚æ—¶å˜æ…¢ï¼ˆéœ€è¦é‡å»ºç¼“å­˜ï¼‰

---

## ğŸ¯ æœ€ä½³å®è·µ

### **å¼€å‘ç¯å¢ƒ**

1. **ä½¿ç”¨å†…å­˜ç›‘æ§è„šæœ¬**
   ```bash
   python scripts/monitor_memory.py 5
   ```

2. **å®šæœŸæ£€æŸ¥å†…å­˜çŠ¶æ€**
   ```bash
   watch -n 5 'free -h'
   ```

3. **å¯ç”¨ DEBUG æ—¥å¿—ï¼ˆæ€§èƒ½åˆ†æï¼‰**
   ```yaml
   # config.yaml
   logging:
     level: DEBUG  # ä¸´æ—¶å¯ç”¨
   ```

### **ç”Ÿäº§ç¯å¢ƒ**

1. **ä½¿ç”¨ systemd ç®¡ç†**
   - è®¾ç½®å†…å­˜é™åˆ¶
   - è‡ªåŠ¨é‡å¯ç­–ç•¥
   - æ—¥å¿—è½®è½¬

2. **ç›‘æ§å‘Šè­¦**
   - ç›‘æ§ `available` å†…å­˜
   - RSS å¢é•¿é€Ÿç‡å‘Šè­¦
   - OOM å‘Šè­¦

3. **å®šæœŸé‡å¯**
   ```bash
   # æ¯å¤©å‡Œæ™¨é‡å¯ï¼ˆå¯é€‰ï¼‰
   0 3 * * * systemctl restart visioncore
   ```

### **æ•…éšœæ’æŸ¥**

#### **é—®é¢˜1ï¼šRSS æŒç»­å¢é•¿**

**å¯èƒ½åŸå› **ï¼š
- Python å¯¹è±¡æœªé‡Šæ”¾ï¼ˆå¾ªç¯å¼•ç”¨ï¼‰
- C++ æ‰©å±•å†…å­˜æ³„æ¼
- numpy æ•°ç»„ç´¯ç§¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä½¿ç”¨ `tracemalloc` å®šä½æ³„æ¼ç‚¹
2. æ£€æŸ¥æ˜¯å¦æœ‰å…¨å±€å˜é‡ç´¯ç§¯æ•°æ®
3. ç¡®è®¤æ‰€æœ‰ `release()` æ–¹æ³•è¢«è°ƒç”¨

#### **é—®é¢˜2ï¼šbuff/cache å æ»¡å†…å­˜**

**å¯èƒ½åŸå› **ï¼š
- é¢‘ç¹è¯»å–å¤§æ–‡ä»¶ï¼ˆæ¨¡å‹æ–‡ä»¶ã€å›¾åƒï¼‰
- mmap æ–‡ä»¶æ˜ å°„æœªé‡Šæ”¾

**åˆ¤æ–­æ–¹æ³•**ï¼š
```bash
# æ£€æŸ¥æ˜¯å¦å½±å“å®é™…å¯ç”¨å†…å­˜
free -h | grep "available"

# å¦‚æœ available å……è¶³ï¼Œbuff/cache é«˜æ˜¯æ­£å¸¸çš„
```

**å¤„ç†æ–¹å¼**ï¼š
- å¦‚æœ `available` å……è¶³ï¼š**æ— éœ€å¤„ç†**
- å¦‚æœ `available` ä¸è¶³ï¼šæ¸…ç†ç¼“å­˜æˆ–å¢åŠ å†…å­˜

#### **é—®é¢˜3ï¼šå…±äº«å†…å­˜æœªé‡Šæ”¾**

**æ£€æŸ¥**ï¼š
```bash
ipcs -m  # æŸ¥çœ‹å…±äº«å†…å­˜
```

**æ¸…ç†**ï¼š
```bash
sudo bash scripts/clear_cache.sh
```

---

## ğŸ“š ç›¸å…³èµ„æº

### **Linux å†…å­˜ç®¡ç†**
- [Linux Memory Management](https://www.kernel.org/doc/html/latest/admin-guide/mm/concepts.html)
- [Understanding Linux Memory](https://www.linuxatemyram.com/)

### **Python å†…å­˜ä¼˜åŒ–**
- [Python Memory Management](https://docs.python.org/3/c-api/memory.html)
- [gc â€” Garbage Collector](https://docs.python.org/3/library/gc.html)

### **å·¥å…·**
- `free`, `top`, `htop` - ç³»ç»Ÿå†…å­˜ç›‘æ§
- `pmap`, `smem` - è¿›ç¨‹å†…å­˜æ˜ å°„
- `valgrind` - C/C++ å†…å­˜æ³„æ¼æ£€æµ‹
- `memory_profiler` - Python å†…å­˜åˆ†æ

---

## âœ… æ€»ç»“

1. **buff/cache é«˜æ˜¯ Linux çš„æ­£å¸¸è¡Œä¸ºï¼Œä¸æ˜¯å†…å­˜æ³„æ¼**
2. **å…³æ³¨ `available` è€Œä¸æ˜¯ `free`**
3. **ä½¿ç”¨ç›‘æ§è„šæœ¬æŒç»­è§‚å¯Ÿ RSS è¶‹åŠ¿**
4. **ç¨‹åºå·²å®ç°å®Œå–„çš„èµ„æºé‡Šæ”¾æœºåˆ¶**
5. **å¿…è¦æ—¶ä½¿ç”¨æ¸…ç†è„šæœ¬ï¼Œä½†é€šå¸¸ä¸éœ€è¦**

å¦‚æœ `available` å†…å­˜å……è¶³ï¼Œ**æ— éœ€æ‹…å¿ƒ buff/cache é«˜**ï¼

